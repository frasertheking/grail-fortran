<h1 id="mlp-resnet-fortran-inference-api">MLP-ResNet (GRAIL) Fortran Inference API</h1>
<p>Here, we put together a small Fortran API to load our folded MLP-ResNet (GRAIL) from HDF5 and run inference. We also include a minimal example app.</p>
<p>This is a living document / WIP, so some things might not work perfectly out of the gate. However, the API is fairly basic, and should integrate fairly easy with current models. You might need to tweak things for different fortran versions etc., but the underlying structure should work.</p>
<p>In the example app, we show how to provide your own data to the model to get the corresponding 12 GMI channel output. Inference is quite fast. 
Also, no need to worry about input scaling, we prebake this into the A0 front affine.</p>
<h2 id="files">Files</h2>
<ul>
<li><code>grail_api.f90</code> - API (<code>load_model</code>, <code>forward_into</code>, <code>predict</code>, <code>describe_model</code>, <code>print_outputs</code>)</li>
<li><code>example_app.f90</code> - demo (self-test + one preset input)</li>
<li><code>grail_export.h5</code> - exported model (from Python)</li>
</ul>
<h2 id="requirements">Requirements</h2>
<ul>
<li><strong>Fortran compiler:</strong> gfortran 9+ (or ifx/ifort/nvfortran).</li>
<li><strong>HDF5 with Fortran bindings:</strong><ul>
<li>Prefer wrapper <strong><code>h5fc</code></strong>; or</li>
<li><code>pkg-config</code> for <code>hdf5-fortran</code>; or</li>
<li>Manual <code>-I</code> / <code>-L -lhdf5_fortran -lhdf5</code>.</li>
</ul>
</li>
</ul>
<h2 id="model-file-contents">Model file contents</h2>
<p>HDF5 datasets (names must match) - this is provided:</p>
<ul>
<li>Front: <code>A0</code>, <code>c0</code></li>
<li>ResBlock1: <code>bn1_gamma</code>, <code>bn1_beta</code>, <code>bn1_mean</code>, <code>bn1_var</code>, <code>bn1_eps</code>, <code>W1</code>, <code>b1</code></li>
<li>ResBlock2: <code>bn2_gamma</code>, <code>bn2_beta</code>, <code>bn2_mean</code>, <code>bn2_var</code>, <code>bn2_eps</code>, <code>W2</code>, <code>b2</code></li>
<li>Skip/Narrow/Out: <code>P</code>, <code>p</code>, <code>An</code>, <code>cn</code>, <code>Ao</code>, <code>co</code></li>
<li>Optional test vectors: <code>probe_x</code> + <code>probe_y_py</code> (preferred) or <code>test_x</code> + <code>test_y</code></li>
</ul>
<h2 id="build">Build</h2>
<pre><code class="lang-bash">h5fc -c -O3 -<span class="hljs-built_in">std</span>=f2008 -Wall -Wextra grail_api.<span class="hljs-built_in">f90</span>
h5fc -O3 -<span class="hljs-built_in">std</span>=f2008 -o example_app grail_api.o example_app.<span class="hljs-built_in">f90</span>
</code></pre>
<h2 id="run">Run</h2>
<p>./example_app</p>
<h2 id="questions">Questions</h2>
<p>Reach out to Sarah Ringerud (sarah.e.ringerud@nasa.gov) or Fraser King (fraser.d.king@nasa.gov) if you have further questions</p>
